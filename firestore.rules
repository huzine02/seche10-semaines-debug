rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // ─── USERS ───────────────────────────────────────────────────────────────
    match /users/{userId} {

      // Lecture : uniquement le propriétaire
      allow read: if request.auth != null && request.auth.uid == userId;

      // Création : uniquement le propriétaire, champs requis présents
      allow create: if request.auth != null
        && request.auth.uid == userId
        && request.resource.data.keys().hasAll(['uid', 'email', 'createdAt', 'onboardingComplete'])
        && request.resource.data.uid == userId;

      // Mise à jour : uniquement le propriétaire
      // Les champs Stripe (stripeCustomerId, subscriptionStatus, etc.) sont
      // écrits par les Firebase Functions (admin SDK) qui bypassent ces règles.
      allow update: if request.auth != null
        && request.auth.uid == userId
        // Interdire aux clients de se falsifier le statut d'abonnement
        && !request.resource.data.diff(resource.data).affectedKeys()
            .hasAny(['stripeCustomerId', 'stripeSubscriptionId', 'subscriptionStatus',
                     'subscriptionStartedAt', 'subscriptionCancelledAt']);

      // Suppression : interdit depuis le client
      allow delete: if false;

      // Sous-collections (journal quotidien, etc.)
      match /journal/{dateKey} {
        allow read, write: if request.auth != null && request.auth.uid == userId;
        allow delete: if false;
      }

      match /{subcollection}/{docId} {
        allow read, write: if request.auth != null && request.auth.uid == userId;
        allow delete: if false;
      }
    }

    // ─── TOUT LE RESTE : REFUSÉ ───────────────────────────────────────────────
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
